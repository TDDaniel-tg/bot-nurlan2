# Руководство по устранению неполадок

## Основные проблемы и их решения

### 1. Ошибка "Your account has run out of conversion credits"

**Проблема:** Закончились кредиты CloudConvert

**Решение:**
```bash
# Проверьте кредиты
python check_credits.py

# Варианты решения:
# 1. Подождать до обновления лимитов (ежемесячно)
# 2. Купить дополнительные кредиты на cloudconvert.com
# 3. Создать новый аккаунт CloudConvert с новым API ключом
```

### 2. Ошибка "max_tokens > 8192"

**Проблема:** Превышен лимит токенов Claude AI

**Решение:** Исправлено в коде - используется max_tokens=8192

### 3. Текст обрезается или не полностью переводится

**Проблема:** Ограничения на размер обрабатываемого текста

**Решение:** Все ограничения убраны:
- ✅ Убрано ограничение на 50 страниц PDF
- ✅ Увеличен размер групп обработки ячеек 
- ✅ Улучшен prompt для Claude AI
- ✅ Все листы обрабатываются независимо от качества

### 4. Claude AI не работает

**Проблема:** Неправильные настройки Claude AI

**Решение:**
```bash
# Проверьте настройки в .env файле
CLAUDE_API_KEY=your_claude_api_key
CLAUDE_MODEL=claude-3-5-sonnet-20241022
CLAUDE_MANUAL_ENABLED=true  # Включить вручную

# Перезапустите бота
python main.py
```

### 5. Проверка работоспособности системы

```bash
# 1. Проверка кредитов CloudConvert
python check_credits.py

# 2. Проверка настроек Claude
python manage_claude.py status

# 3. Запуск бота
python main.py
```

## Текущие настройки (без ограничений)

### CloudConvert
- ✅ Без ограничения на количество страниц
- ✅ Лучшее качество OCR (tesseract)
- ✅ Только русский язык распознавания
- ✅ Предобработка изображений

### Claude AI  
- ✅ Максимум токенов: 8192 (лимит модели)
- ✅ Групповая обработка: 30 ячеек за раз
- ✅ Обработка всех листов независимо от качества
- ✅ Улучшенный prompt без обрезки текста

### Размеры файлов
- ✅ Максимальный размер PDF: 20MB
- ✅ Без ограничения на количество страниц
- ✅ Без ограничения на количество ячеек в таблице

## Команды для диагностики

```bash
# Проверить все кредиты и настройки
python check_credits.py

# Управление Claude AI
python manage_claude.py status
python manage_claude.py enable
python manage_claude.py disable

# Запуск с подробными логами
python main.py --log-level DEBUG
```

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи бота
2. Запустите check_credits.py
3. Убедитесь что все API ключи правильно настроены
4. Перезапустите бота

Система настроена для работы с полными документами без обрезки! 

# Улучшения качества конвертации (версия 2.0)

## Проблема: Урезанные данные в результате конвертации

**Симптомы:**
- Конвертированный файл содержит значительно меньше данных чем оригинал
- Потеряны адреса, банковские реквизиты, номера телефонов
- Таблицы неполные или разорванные

**Решение:**
Реализована многоступенчатая система улучшения качества:

### 1. Улучшенные настройки OCR
- **Мультиязычное распознавание**: rus + eng
- **Максимальная точность OCR**: best quality
- **Высокое разрешение**: 300-600 DPI
- **Улучшенная предобработка**: удаление шума, коррекция контраста
- **Специальные настройки для таблиц**: advanced table extraction

### 2. Множественные стратегии конвертации
**Стратегия 1 (основная):** PDF → DOCX → XLSX
- Двухэтапная конвертация для лучшего сохранения структуры
- Сохранение форматирования, таблиц, изображений

**Стратегия 2 (альтернативная):** PDF → CSV → XLSX  
- Максимальное извлечение текстовых данных
- Специальные настройки для русских данных (разделитель ";")
- Активируется автоматически при неуспехе первой стратегии

### 3. ИИ-постобработка с Claude AI
- **Восстановление потерянных данных**: ИНН, КПП, ОГРН, адреса
- **Исправление OCR ошибок**: украинские символы → русские
- **Структурное восстановление**: восстановление табличной структуры
- **Автоматическое включение** при наличии API ключа

### 4. Активация улучшений

```bash
# Добавьте в .env для активации Claude AI
CLAUDE_API_KEY=your_claude_api_key_here
CLAUDE_MANUAL_ENABLED=true  # по умолчанию включен
```

### 5. Мониторинг качества
Логи теперь показывают:
- Какая стратегия конвертации используется
- Успешность каждого этапа
- Результаты ИИ-улучшений

**Пример лога:**
```
INFO: Starting conversion with improved quality settings
INFO: Processing job 12345 with standard enhanced strategy  
INFO: Successfully converted file.pdf using standard enhanced strategy
INFO: Text enhancement completed for file.pdf
``` 